# 4. Head 上采样 NAS 搜索结果 & 推荐

> 返回 [目录](00_README.md)

---

## 7.1 搜索配置

- **Predict 卷积**: 全部固定为 7×7（保证光流预测精度）
- **骨干**: ShuffleNet + Bilinear（性能最优骨干）
- **搜索对象**: Head1 和 Head2 的上采样方式（7 种 Choice）
- **测试分辨率**: 6 种 (120×160 ~ 384×512)

**测试数据来源**: `output_benchmark_upsample/benchmark_upsample_results.csv`

## 7.2 192×256 关键结果

| Choice | FPS | SRAM (MB) | vs Conv3×3 基线 |
|--------|-----|-----------|----------------|
| **DSConv3×3** | **10.15** | **1.69** | +4.9% ⭐ 最快 |
| Shuffle | 10.13 | 2.81 | +4.7% (SRAM +66%) |
| **Conv3×3** | **9.68** | **1.69** | 基线 ✅ |
| Conv5×5 | 7.31 | 1.69 | -24.5% |
| MBConv_E4 | 6.26 | 1.69 | -35.3% |
| Conv7×7 | 5.51 | 1.69 | -43.1% |
| MBConv_E6 | 2.03 | 1.77 | -79.0% ❌ 最慢 |

## 7.3 MBConv 在 Head 的异常行为

MBConv_E4 在 **156×208** 分辨率出现 FPS 断崖下跌：

| 分辨率 | Conv3×3 FPS | MBConv_E4 FPS | 异常？ |
|--------|-------------|---------------|--------|
| 192×256 | 9.68 | 6.26 | 正常（慢但可预期） |
| **156×208** | **13.48** | **3.40** | **❌ FPS 骤降 75%** |
| 120×160 | 19.88 | 5.42 | ❌ 同样异常 |

原因：156×208 时 Head2 全分辨率特征图 = 128ch × 156 × 208 = 4.1 MB >> SRAM，触发大量 OffFlash 访问。

MBConv_E6 在 **192×256** 就已溢出：
```
head_mbconv_e6_head2/conv2d:     Op Cycles = 75,709,440 (38.4%), OffFlash AC = 75,709,440
head_mbconv_e6_head2/depthwise:  Op Cycles = 17,142,752 (8.7%),  OffFlash AC = 15,621,120
head_mbconv_e6_head2/conv2d_1:   Op Cycles = 18,973,952 (9.6%),  OffFlash AC = 18,973,952
```

## 7.4 Shuffle 的 SRAM 问题

Shuffle 虽然 FPS 高，但 SRAM 显著上升：

| 分辨率 | Conv3×3 SRAM | Shuffle SRAM | 增幅 |
|--------|-------------|-------------|------|
| 192×256 | 1.69 MB | 2.81 MB | +66% |
| 264×352 | 3.29 MB | 5.48 MB | +67% |
| 384×512 | 6.75 MB | 11.25 MB | +67% |

原因：ShuffleNet 的 channel split + concat 操作需要同时保存两个分支的数据。

## 7.5 全分辨率 FPS 曲线

```
FPS @ 各分辨率 (数值越高越好)
       120×160  156×208  192×256  264×352  300×400  384×512
DSConv   20.7    14.2     10.1     5.5      4.3      2.7
Conv3×3  19.9    13.5      9.7     5.2      4.0      2.5
Conv5×5  15.7    10.4      7.3     3.9      3.1      1.9
Conv7×7  12.1     7.9      5.5     2.9      2.3      1.4
MBConv4   5.4     3.4      6.3     3.4      2.6      1.6  ← 156×208 断崖
MBConv6   4.5     2.8      2.0     2.8      2.2      1.4  ← 全线异常
Shuffle  21.0    14.3     10.1     5.5      4.3      2.7  (但 SRAM 高)
```

---

## 8. 最终推荐

### 8.1 推荐的 NAS 搜索空间

排除 MBConv 和 Shuffle 后，精简为 **3 个可靠选项**：

| Choice | 优势 | 劣势 | 适合场景 |
|--------|------|------|---------|
| **Conv3×3** | SRAM 最低，稳定可靠 | 感受野小 | ✅ 安全基线 |
| **Conv5×5** | 感受野适中 | FPS 降 25% | 精度优先场景 |
| **DSConv3×3** | 最快 (+5%), SRAM 不变 | DW 精度可能略低 | ⚡ 速度优先场景 |

理由：
- **SRAM 完全一致** (1.69 MB @ 192×256)，无异常行为
- **FPS 梯度清晰**: 10.15 → 9.68 → 7.31，适合自动化搜索
- **无 OffFlash 溢出风险**

### 8.2 不推荐的选项

| Choice | 排除原因 |
|--------|---------|
| Conv7×7 | Head 中 FPS 降 43%，收益不明确 |
| MBConv_E4 | 低分辨率 SRAM 溢出，FPS 断崖下跌 |
| MBConv_E6 | 全线 OffFlash 溢出，速度灾难性 |
| Shuffle | SRAM 增加 66%，在内存受限场景不利 |

### 8.3 骨干推荐

| 优先级 | 骨干选择 | FPS (192×256) | SRAM | 说明 |
|--------|---------|---------------|------|------|
| 🥇 | ShuffleNet | 12.32 | 1.69 MB | 最快，骨干省 87% cycles |
| 🥈 | MBConv_E4 | 9.73 | 1.69 MB | 次快，骨干省 37% cycles |
| 🥉 | ResNet | 8.41 | 1.69 MB | 基线，简单可靠 |
| ❌ | MBConv_E6 | 8.46 | 1.69 MB | 比 ResNet 几乎无提升 |

### 8.4 Predict 卷积

全部固定为 **7×7**。原因：
- Head0 (H/4 分辨率) 的 7×7 卷积对 FPS 影响极小
- Head1/Head2 的 7×7 有一定 FPS 代价，但用户明确选择保留以保证光流预测精度
- 7×7 的大感受野有助于捕获更大范围的运动信息

